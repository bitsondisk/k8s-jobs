# Kubernetes Job System
This is a set of scripts for starting kubernetes jobs and interactive shells, given the necessary options
on the command line.

## kbatch
```usage: kbatch [-h] [--file FILE] [--image IMAGE]
              [--container-name CONTAINER_NAME] [--name NAME] [--cpu CPU]
              [--memory MEMORY] [--disk DISK] [--cpu-limit CPU_LIMIT]
              [--memory-limit MEMORY_LIMIT] [--disk-limit DISK_LIMIT]
              [--time TIME] [--preemptible]
              [cmd [args...]]

positional arguments:
  cmd [args...]         Command with arguments to run in the given container
                        (optional)

optional arguments:
  -h, --help            show this help message and exit
  --file FILE, -f FILE  Config yaml file to use (optional)
  --image IMAGE, -i IMAGE
                        Docker container image to run (required unless a yaml
                        is provided)
  --container-name CONTAINER_NAME
                        Container name to use (optional)
  --name NAME, -n NAME  Name of the job (an autogenerated id will be added to
                        this name)
  --cpu CPU             CPU reservation (In CPUs: 100m (== 0.1), 4)
  --memory MEMORY       Memory reservation (In bytes: 1024, 1e6, 100M, 128Mi)
  --disk DISK           Disk reservation (In bytes: 1024, 1e6, 100M, 128Mi)
  --cpu-limit CPU_LIMIT
                        CPU limit (In CPUs: 100m (== 0.1), 4)
  --memory-limit MEMORY_LIMIT
                        Memory limit (In bytes: 1024, 1e6, 100M, 128Mi)
  --disk-limit DISK_LIMIT
                        Disk limit (In bytes: 1024, 1e6, 100M, 128Mi)
  --time TIME           Time limit (seconds)
  --preemptible, -p     Allow scheduling on preemptible nodes
```

This command will run the given docker image or yaml configuration as a batch job through kubernetes,
and returns the job id. It will fill in the appropriate fields for the command and args to run, the job name, and
memory/cpu/disk reservation and/or limits, if given. Note that whether a job name is specified or not an
auto-generated name is used (in Kubernetes) so that a job configuration can be started more than once for
different instances.

## klist
`usage: klist`

This command lists all currently running jobs. See: `kubectl get jobs` for advanced options.

## kstatus
`usage: kstatus job-id`

This command lists detailed information for a given job. See: `kubectl describe job` for advanced options.

## kcancel
`usage: kcancel job-id [additional job-ids]`

This command will cancel one or more running jobs. See: `kubectl delete` for advanced options.
Note that this command can also be used to delete old information for completed jobs.


## krun
```usage: krun [-h] --image IMAGE [--name NAME] [--env ENV]
            [cmd [args...]]

positional arguments:
  cmd [args...]         Command with arguments to run in the given container
                        (optional)

optional arguments:
  -h, --help            show this help message and exit
  --image IMAGE, -i IMAGE
                        Docker container image to run
  --name NAME, -n NAME  Name of the job (an autogenerated id will be added to
                        this name)
  --env ENV             Environment variable to set in the format
                        "VARIABLE=value"
```

This command will start the given container as an interactive job in kubernetes for shell commands or other interactive
processes for R&D or debugging purposes. If no command is specified, this will default to a bash shell.

## Installation
To install the local version for development or usage, run:
`./setup.py install`

Do note that you will need the Google Cloud SDK (for kubectl) installed to use this package.

## Running tests
To lint, run:
`flake8`

To run tests:
`pytest -m pytest . -vvv`

## Deploy new version
After developing, make sure to modify the current version in setup.py before merging.
After merging, run the following commands:
```
git tag v{YOUR_VERSION}
git push --tags
```
Your version should be a semantic version (e.i. 1.2.1)
