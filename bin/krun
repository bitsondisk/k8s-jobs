#!/usr/bin/env python3

import argparse
import subprocess

from k8s_jobs.klib import random_string


def run_k8s_interactive(args):
    job_name = args.name if args.name else f'krun-{random_string(8)}'

    cmd_args = ' '.join(args.cmd_args) if args.cmd_args else 'bash'

    env = ''
    if args.env:
        env = ' '.join([f'--env="{e}"' for e in args.env])

    image = args.image

    subprocess.run([f'kubectl run -i --tty --rm "{job_name}" --image="{image}" --restart=Never {env} '
                    f'-- {cmd_args}'], shell=True)


def main():
    """ The krun script is designed to run a given interactive job in kubernetes. """
    parser = argparse.ArgumentParser()

    parser.add_argument('--image', '-i', help='Docker container image to run', required=True)

    parser.add_argument('--name', '-n', help='Name of the job (an autogenerated id will be added to this name)')
    parser.add_argument('--env', help='Environment variable to set in the format "VARIABLE=value"', action='append')

    parser.add_argument('cmd_args', metavar='cmd [args...]', nargs='*',
                        help='Command with arguments to run in the given container (optional)')

    args = parser.parse_args()

    run_k8s_interactive(args)


if __name__ == '__main__':
    main()
